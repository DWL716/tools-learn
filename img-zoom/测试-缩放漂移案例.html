<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      .box {
        width: 400px;
        height: 600px;
        margin: 0 auto;
        overflow: hidden;
        margin-top: 50px;
        position: relative;
      }
      .box img {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <img id="zoom-img" src="./img/乌孙.png" alt="" />
    </div>

    <script type="text/javascript">
      // 初版
      let ratol = 1;
      let zoomImg = document.querySelector("#zoom-img");
      let zoomBox = document.querySelector(".box");
      let def_w = zoomImg.getBoundingClientRect().width;
      let def_h = zoomImg.getBoundingClientRect().height;

      let old_l = 0;
      let old_t = 0;
      let deepL = 0;
      let deepT = 0;
      let o_L = 0;
      let o_T = 0;

      zoomImg.onmousewheel = function (e) {
        console.log("向上滑", e, zoomImg.getBoundingClientRect());
        let orgiin_Left = e.clientX - e.target.getBoundingClientRect().left;
        let orgiin_Top = e.clientY - e.target.getBoundingClientRect().top;
        let box_Left = e.clientX - zoomBox.getBoundingClientRect().left;
        let box_Top = e.clientY - zoomBox.getBoundingClientRect().top;

        let old_W = e.target.getBoundingClientRect().width;
        let old_H = e.target.getBoundingClientRect().height;

        if (e.wheelDelta > 0) {
          ratol += 0.05;
          console.log("向上滑");
          e.target.style.height =
            zoomBox.getBoundingClientRect().height * ratol + "px";
          e.target.style.width =
            zoomBox.getBoundingClientRect().width * ratol + "px";
        } else {
          ratol -= 0.05;
          console.log("向下滑");
          e.target.style.height =
            zoomBox.getBoundingClientRect().height * ratol + "px";
          e.target.style.width =
            zoomBox.getBoundingClientRect().width * ratol + "px";
          if (
            def_w >= zoomImg.getBoundingClientRect().width ||
            def_h >= zoomImg.getBoundingClientRect().height
          ) {
            console.log("超出范围了");
            ratol = 1;
            e.target.style.height = def_h + "px";
            e.target.style.width = def_w + "px";
          }
        }
        // 当鼠标移动后再进行缩放，图片会进行漂移，这是因为第一次根据 0,0 来计算出来的
        /**
         * 当第一次缩放后移动鼠标后再进行缩放，这时候会进行漂移，
         * 因为这时候box_Top - box_Top * ratol 得到的偏移量有问题，
         * 因为 box_Top * ratol 并不是图片真正的缩放，需要加上图片的真实top来进行计算
         * ----- 参考 ./index-js4.html 文件
         */

        if (old_l === 0 || old_t == 0) {
          deepL = box_Left;
          deepT = box_Top;
        }

        old_l = orgiin_Left;
        old_t = orgiin_Top;

        if (box_Top - deepT !== 0) {
          o_T -= +zoomImg.style.top.slice(0, -2) * 0.05;
        }
        if (box_Left - deepL !== 0) {
          o_L -= +zoomImg.style.left.slice(0, -2) * 0.05;
        }
        console.log("ratol", ratol, box_Left - deepL, o_L);
        e.target.style.top = box_Top - box_Top * ratol + "px";
        e.target.style.left = box_Left - box_Left * ratol + "px";
        deepL = box_Left;
        deepT = box_Top;
      };
    </script>
  </body>
</html>
